{% extends "base.html" %}

{% block title %}Administration - FLBB Statistics{% endblock %}

{% block page_title %}‚öôÔ∏è Administration{% endblock %}
{% block page_description %}Data statistics and system information{% endblock %}

{% block content %}
        <div class="stats-section">
            <h2>üìä Data Overview</h2>
            <div class="stat-summary">
                <div class="stat-card">
                    <h3>Total Games</h3>
                    <p>{{ data_stats.total_games }}</p>
                </div>
                <div class="stat-card">
                    <h3>Total Teams</h3>
                    <p>{{ data_stats.total_teams }}</p>
                </div>
                <div class="stat-card">
                    <h3>Total Players</h3>
                    <p>{{ data_stats.total_players }}</p>
                </div>
                <div class="stat-card">
                    <h3>Divisions</h3>
                    <p>{{ data_stats.total_divisions }}</p>
                </div>
            </div>
        </div>

        <div class="stats-section">
            <h2>üóìÔ∏è Season Information</h2>
            <div class="stat-summary">
                <div class="stat-card">
                    <h3>Current Season</h3>
                    <p>{{ season_info.season_display }}</p>
                </div>
                <div class="stat-card">
                    <h3>Season ID</h3>
                    <p>{{ season_info.season_id }}</p>
                </div>
                <div class="stat-card">
                    <h3>Event Name</h3>
                    <p style="font-size: 0.9em;">{{ season_info.event_name }}</p>
                </div>
            </div>
        </div>

        <div class="stats-section">
            <h2>üì¶ Season Archive Management</h2>
            <div style="background: white; border-radius: 10px; padding: 20px; margin-bottom: 20px;">
                <h3>Available Archives</h3>
                {% if available_archives %}
                <table style="width: 100%; border-collapse: collapse; margin-top: 10px;">
                    <thead>
                        <tr style="background: #f8f9fa;">
                            <th style="padding: 10px; border: 1px solid #dee2e6; text-align: left;">Archive File</th>
                            <th style="padding: 10px; border: 1px solid #dee2e6; text-align: left;">Season</th>
                            <th style="padding: 10px; border: 1px solid #dee2e6; text-align: left;">Size</th>
                            <th style="padding: 10px; border: 1px solid #dee2e6; text-align: left;">Modified</th>
                            <th style="padding: 10px; border: 1px solid #dee2e6; text-align: left;">Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for archive in available_archives %}
                        <tr>
                            <td style="padding: 10px; border: 1px solid #dee2e6;">{{ archive.filename }}</td>
                            <td style="padding: 10px; border: 1px solid #dee2e6;">
                                {% if archive.season_id %}{{ archive.season_id }}{% else %}Unknown{% endif %}
                            </td>
                            <td style="padding: 10px; border: 1px solid #dee2e6;">{{ "%.1f"|format(archive.size / 1024 / 1024) }} MB</td>
                            <td style="padding: 10px; border: 1px solid #dee2e6;">{{ archive.modified }}</td>
                            <td style="padding: 10px; border: 1px solid #dee2e6;">
                                {% if archive.valid %}
                                    <span style="color: #28a745;">‚úì Valid</span>
                                {% else %}
                                    <span style="color: #dc3545;">‚úó Invalid</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                <p style="color: #666; font-style: italic;">No archives found in current directory</p>
                {% endif %}
                
                <div style="margin-top: 20px;">
                    <h3>Import Season Archive</h3>
                    <form id="importForm" enctype="multipart/form-data" style="margin-top: 10px;">
                        <div style="margin-bottom: 10px;">
                            <label for="archive_file" style="display: block; margin-bottom: 5px; font-weight: bold;">Select Archive File (.zip):</label>
                            <input type="file" id="archive_file" name="archive_file" accept=".zip" required style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                        <button type="submit" style="background: #007bff; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer;">Import Archive</button>
                    </form>
                    <div id="importStatus" style="margin-top: 10px; padding: 10px; border-radius: 4px; display: none;"></div>
                </div>
            </div>
        </div>

        <div class="stats-section">
            <h2>üèÄ Game Statistics</h2>
            <div class="stat-summary">
                <div class="stat-card">
                    <h3>Avg Home Score</h3>
                    <p>{% if data_stats.avg_home_score != 'N/A' %}{{ "%.1f"|format(data_stats.avg_home_score) }}{% else %}N/A{% endif %}</p>
                </div>
                <div class="stat-card">
                    <h3>Avg Away Score</h3>
                    <p>{% if data_stats.avg_away_score != 'N/A' %}{{ "%.1f"|format(data_stats.avg_away_score) }}{% else %}N/A{% endif %}</p>
                </div>
                <div class="stat-card">
                    <h3>Highest Scoring Game</h3>
                    <p>{{ data_stats.highest_scoring_game }}</p>
                </div>
                <div class="stat-card">
                    <h3>Data Points</h3>
                    <p>{{ data_stats.total_data_points }}</p>
                </div>
            </div>
        </div>

        {% if data_stats.date_range_start != 'N/A' %}
        <div class="stats-section">
            <h2>üìÖ Date Range</h2>
            <div class="stat-summary">
                <div class="stat-card">
                    <h3>First Game</h3>
                    <p>{{ data_stats.date_range_start }}</p>
                </div>
                <div class="stat-card">
                    <h3>Latest Game</h3>
                    <p>{{ data_stats.date_range_end }}</p>
                </div>
            </div>
        </div>
        {% endif %}

        <div class="stats-section">
            <h2>üì° Data Source Information</h2>
            <div class="stat-summary">
                <div class="stat-card">
                    <h3>Data Source</h3>
                    {% if data_source_info.source == 'new_data' %}
                    <p style="color: #27ae60;">‚úì New Data</p>
                    {% elif data_source_info.source == 'backup_csv' %}
                    <p style="color: #f39c12;">‚ö†Ô∏è Backup CSV</p>
                    {% else %}
                    <p style="color: #e74c3c;">‚ùå No Data</p>
                    {% endif %}
                </div>
                <div class="stat-card">
                    <h3>Source Description</h3>
                    <p>{{ data_source_info.source_description }}</p>
                </div>
                <div class="stat-card">
                    <h3>Last Update</h3>
                    <p>{{ data_source_info.last_update or 'Unknown' }}</p>
                </div>
            </div>
        </div>

        {% if data_stats.division_games %}
        <div class="stats-section">
            <h2>üèÜ Games by Division</h2>
            <table>
                <thead>
                    <tr>
                        <th>Division</th>
                        <th>Number of Games</th>
                        <th>Percentage</th>
                    </tr>
                </thead>
                <tbody>
                    {% for division, count in data_stats.division_games.items() %}
                    <tr>
                        <td><strong>{{ division }}</strong></td>
                        <td>{{ count }}</td>
                        <td>{{ "%.1f"|format((count / data_stats.total_games) * 100) }}%</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% endif %}

        <div class="stats-section">
            <h2>üíæ File System Information</h2>
            <table>
                <thead>
                    <tr>
                        <th>File</th>
                        <th>Status</th>
                        <th>Size (bytes)</th>
                        <th>Last Modified</th>
                    </tr>
                </thead>
                <tbody>
                    {% for filename, info in file_stats.items() %}
                    <tr>
                        <td><strong>{{ filename }}</strong></td>
                        <td>
                            {% if info %}
                                <span style="color: #27ae60;">‚úì Available</span>
                            {% else %}
                                <span style="color: #e74c3c;">‚úó Not Found</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if info %}
                                {{ "{:,}".format(info.size) }}
                            {% else %}
                                N/A
                            {% endif %}
                        </td>
                        <td>
                            {% if info %}
                                {{ info.modified | int | round | int }}
                            {% else %}
                                N/A
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <div class="stats-section">
            <h2>üîß System Information</h2>
            <div class="stat-summary">
                <div class="stat-card">
                    <h3>Data Columns</h3>
                    <p>{{ data_stats.data_columns }}</p>
                </div>
                <div class="stat-card">
                    <h3>Memory Usage</h3>
                    <p>{% if data_stats.total_data_points > 0 %}{{ "%.2f"|format((data_stats.total_data_points * 8) / 1024 / 1024) }} MB{% else %}N/A{% endif %}</p>
                </div>
                <div class="stat-card">
                    <h3>Status</h3>
                    <p style="color: #27ae60;">‚úì Active</p>
                </div>
            </div>
        </div>

        <div class="stats-section">
            <h2>üìã Available Endpoints</h2>
            <table>
                <thead>
                    <tr>
                        <th>Page</th>
                        <th>Endpoint</th>
                        <th>Description</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><strong>Home</strong></td>
                        <td>/</td>
                        <td>Division standings and team rankings</td>
                    </tr>
                    <tr>
                        <td><strong>Statistics</strong></td>
                        <td>/statistics</td>
                        <td>Comprehensive game and player statistics</td>
                    </tr>
                    <tr>
                        <td><strong>Player Stats</strong></td>
                        <td>/player-stats</td>
                        <td>Individual player performance analysis</td>
                    </tr>
                    <tr>
                        <td><strong>Team Stats</strong></td>
                        <td>/team-stats</td>
                        <td>Team performance and detailed analysis</td>
                    </tr>
                    <tr>
                        <td><strong>Deep Analysis</strong></td>
                        <td>/deeper-analysis</td>
                        <td>Advanced insights and impact analysis</td>
                    </tr>
                    <tr>
                        <td><strong>Administration</strong></td>
                        <td>/admin</td>
                        <td>System information and data statistics</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <script>
        document.getElementById('importForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const statusDiv = document.getElementById('importStatus');
            
            // Show loading status
            statusDiv.style.display = 'block';
            statusDiv.style.background = '#e7f3ff';
            statusDiv.style.color = '#0066cc';
            statusDiv.innerHTML = '‚è≥ Importing archive, please wait...';
            
            try {
                const response = await fetch('/admin/import-season', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success) {
                    statusDiv.style.background = '#d4edda';
                    statusDiv.style.color = '#155724';
                    statusDiv.innerHTML = `‚úÖ ${result.message}<br>
                        Season ID: ${result.season_id}<br>
                        Target Directory: ${result.target_directory}`;
                    // Reset the form
                    this.reset();
                    // Reload page after 3 seconds to update archive list
                    setTimeout(() => {
                        window.location.reload();
                    }, 3000);
                } else {
                    statusDiv.style.background = '#f8d7da';
                    statusDiv.style.color = '#721c24';
                    statusDiv.innerHTML = `‚ùå Import failed: ${result.error}`;
                }
            } catch (error) {
                statusDiv.style.background = '#f8d7da';
                statusDiv.style.color = '#721c24';
                statusDiv.innerHTML = `‚ùå Error: ${error.message}`;
            }
        });
        </script>
{% endblock %}